#!/usr/bin/env bash
# SOURCE  https://github.com/adrw/.files

# ADRW Bootstrap Standard Methods
prefix="adrw::"
# status opt_code "Main update text" "optional script name override"
function status() {
  Reset="$(tput sgr0)"       # Text Reset
  Red="$(tput setaf 1)"          # Red
  Green="$(tput setaf 2)"        # Green
  Yellow="$(tput setaf 3)"          # Yellow
  Blue="$(tput setaf 4)"         # Blue
  if [ "$#" -lt 3 ]; then   # if no name override passed in, take name "adrw" if $0 is status, $0 otherwise
    [ $(basename "${0}") = "status" ] && scriptname="adrw" || scriptname=$(basename "${0}")
  else
    scriptname="${1}"
  fi

  echo "${Red}status is deprecated.${Reset} Uses adrwl instead."
  
  case "${1}" in
    a)        echo ""; echo "${Blue}<|${scriptname:0:1}${Reset} [ ${2} ]" ;;
    b)        echo "${Green}ok: [ ${2} ] ${div:$((${#2}+9))}${Reset}" ;;
    s|status) echo "${Blue}<|${scriptname:0:1}${Reset} [ ${2} ]" ;;
    t|title)  echo "${Blue}<|${scriptname}${Reset} [ ${2} ]" ;;
    e|err)    echo "${Red}fatal: [ ${2} ]" ;;
    w|warn)   echo "${Yellow}warn: [ ${2} ]" ;;
    *)        echo "${Blue}<| ${Reset}${*}"
  esac
}

function adrwl() {
  function usage() {
    cat << EOF
adrwl logging library for bash

Format
  <|${_timestamp}${_status}${_prefix} ${_content}

Options

  -p prefix
  -s status text

  Levels
  -d debug
  -e error
  -f fatal
  -i info
  -t trace
  -w warn

Usage

  adrwl -p ansible -s start -i Ansible is starting
  $ 2018-09-08 14:22:12<|ansible [ start ] |>Ansible is starting

  or alias functions:

  DEBUG() => adrwl -d $*
  ERROR() => adrwl -e $*
  FATAL() => adrwl -f $*
  INFO()  => adrwl -i $*
  TRACE() => adrwl -t $*
  WARN()  => adrwl -w $*
EOF
  }

  Reset="$(tput sgr0)"       # Text Reset
  Red="$(tput setaf 1)"          # Red
  Green="$(tput setaf 2)"        # Green
  Yellow="$(tput setaf 3)"          # Yellow
  Blue="$(tput setaf 4)"         # Blue
  dateFormat="+%Y-%m-%d %T"

  _prefix=""
  _status=""
  _timestamp="[$(date $dateFormat)]"
  _color=$Reset
  _start="$Blue<|$Reset"
  _end="$Blue|>$Reset"

  while getopts "h?defitws:p:" opt; do
    case "$opt" in
      h|\?)      usage  ;;
      s)        _status="$OPTARG" ;;
      p)        _prefix="[$OPTARG]" ;;
      d)        _status="DEBUG"; _color=$Blue  ;;
      e)        _status="ERROR"; _color=$Red ;;
      f)        _status="FATAL"; _color=$Red ;;
      i)        _status="INFO"; _color=$Green ;;
      t)        _status="TRACE"; _color=$Blue  ;;
      w)        _status="WARN"; _color=$Yellow  ;;
    esac
  done
  shift $((OPTIND-1));
  _content="$*"

  [[ ! -z $_status ]] && _status="[${_color}${_status}${Reset}]"
  echo "${_start}${_timestamp}${_status}${_prefix} ${_content}"
}

function DEBUG() { adrwl -d $* }
function ERROR() { adrwl -e $* }
function FATAL() { adrwl -f $* }
function INFO() { adrwl -i $* }
function TRACE() { adrwl -t $* }
function WARN() { adrwl -w $* }

# safe_download ./local/path/file.sh https://remote.com/path/file.sh
function safe_download() {
  timestamp="`date '+%Y%m%d-%H%M%S'`"
  if [ ! -f "$1" ]; then
    status a "Download ${1}"
    curl -s -o $1 $2
    status b "Download ${1}"
  else
    status a "Update ${1}"
    mv $1 $1.$timestamp
    curl -s -o $1 $2
    if diff -q "$1" "$1.$timestamp" > /dev/null; then rm $1.$timestamp; fi
    status b "Update ${1}"
  fi
}

# safe_source ./path/file.sh ~/.bashrc
function safe_source() {
  if [[ -z $(grep "$1" "$2") ]]; then echo "source $1" >> $2; fi
}

# runs script with bumper status output
function run_script() {
  exec=$*
  script=$1
  name=$(basename ${script})
  status a "${name}"
  ${exec}
  status b "${name}"
}

# use ~/.zshplugins -> supercrabtree/k with fallback to ls -la
function safe_k() {
  if type k &> /dev/null; then
    k -a $@
  else
    ls -la $@
  fi
}

# Killall Process from search
function killall() {
  if [ $# -eq 0 ]; then
    status e "Usage: killall <grep process search team>"
  else
		for pid in `ps -ef | grep "${1}" | awk '{print $2}'` ; do kill $pid ; done
	fi;
}

# Decapitate git repo ‚Äì¬†headless ‚Äì (disregard all local changes, reset back to master)
function decap() {
  git fetch --all
  if [ $# -eq 0 ]; then
    git reset --hard origin/master
  else
    git reset --hard $1
  fi
}

# git checkout
function gco {
  if [[ $# == 0 ]]; then
    git checkout master
  else
    git checkout "$@"
  fi
}

# update etchosts. has bias towards maintaining the default (locked down) state
function etc() {
  name="${prefix}${0}"
  hosts="/etc/hosts"
  default_hosts=".no-social.hosts"
  default_hosts_dir="/Users/me/.files/ansible/roles/etchosts/files/"
  alt_hosts=".raw-ads.hosts"
  wait=60
  
  if [ $# -eq 0 ]; then
    hosts_dir="$default_hosts_dir"; new_hosts="$default_hosts"
  elif [ $# -eq 1 ]; then
    hosts_dir="$default_hosts_dir"; new_hosts="$1"
  elif [ $# -eq 2 ]; then
    hosts_dir="$1"; new_hosts="$2"
  else
    status e "Invalid operation."
    status t "Usage: default dir dhr = ${default_hosts_dir}"
    status t " etc              toggles dhr/${default_hosts} <-> dhr/${alt_hosts}"
    status t " etc {new}        installs dhr/{new}"
    status t " etc {dir} {new}  installs {dir}{new}"
    status t " etc {dir} \"\"     installs {new}"
    return
  fi

  # determine if default hosts is currently installed at /etc/hosts
  etc_default_diff=`diff ${hosts} ${default_hosts_dir}${default_hosts} | wc | awk '{print $1}'`
  etc_new_diff=`diff ${hosts} ${hosts_dir}${new_hosts} | wc | awk '{print $1}'`

  if [[ $etc_new_diff -eq 0 && $etc_default_diff -ne 0 ]]; then
    status b "üç∫  ${hosts} already = ${new_hosts}"
    sudo -k
    return
  elif [[ $etc_new_diff -eq 0 && $etc_default_diff -eq 0 ]]; then
    updated_hosts="${alt_hosts}"
    etc_new_diff=`diff ${hosts} ${hosts_dir}${alt_hosts} | wc | awk '{print $1}'`
    status w "Updating ${hosts} => ${updated_hosts} in ${wait} seconds..."
    sleep ${wait}
  elif [[ $etc_new_diff -ne 0 && $etc_default_diff -eq 0 ]]; then
    updated_hosts="${new_hosts}"
    status w "Updating ${hosts} => ${updated_hosts} in ${wait} seconds..."
    sleep ${wait}
  else
    updated_hosts="${new_hosts}"    
  fi

  status t "Update ${hosts} => ${updated_hosts}" "${name}"
  sudo cp ${hosts_dir}${updated_hosts} /etc/hosts

  etc_new_diff=`diff ${hosts} ${hosts_dir}${updated_hosts} | wc | awk '{print $1}'`

  if [ $etc_new_diff -eq 0 ]; then
    sudo dscacheutil -flushcache  # flush dns cache
    sudo killall -HUP mDNSResponder
    status b "üç∫  Fin. ${hosts} = ${updated_hosts}"
  else    
    status e "${hosts} update failed."
  fi
  sudo -k # remove sudo permissions
}

# Rename all files to their first line
# in_dir/123431.txt that has first line of "Notes for Dec 16 2010"
# in_dir/123431.txt => out_dir/Notes for Dec 16 2010.txt
function rename_first_line() {
  name="${prefix}${0}"
  if [ $# -ne 2 ]; then
    status e "Usage: rename_first_line <in_dir> <out_dir>"
  else
    in_dir=$1
    out_dir=$2
    mkdir -p $out_dir

    status t "$in_dir/filename.ext => $out_dir/first_line.ext" "${name}"

    for file in $in_dir/*; do
      first_line=$(head -n 1 $file | cut -c-40 | awk '$1=$1')
      extension="${file##*.}"
      cp_err=$(cp "$file" "${out_dir}/${first_line}.${extension}" 2>&1)
      if [[ $cp_err != "" || $(diff -q $file ${out_dir}/${first_line}.${extension}) ]]; then
        status e "$file : $cp_err"
      # else
        # status b "$file => ${out_dir}/${first_line}.${extension}"
      fi
    done

    status b "${in_dir}/filename.ext => ${out_dir}/first_line.ext"
  fi
  status b "üç∫  Fin. ${in_dir} => ${out_dir}"
}

# Removes admin privileges
# Follows macOS-Security-and-Privacy-Guide ‚Äì¬†@drduh guidelines
# Find GeneratedUID of account with 
#   $ dscl . -read /Users/<username> GeneratedUID
# Remove from admin with 
#   $ sudo dscl . -delete /Groups/admin GroupMembers <GeneratedUID>
function chmod_admin() {
  name="${prefix}${0}"
  if [ $# -ne 1 ]; then
    status e "Usage: chmod_admin <username>"
  elif [[ "$(uname)" != "Darwin"  ]]; then
    status e "Usage: only run this command on macOS"
  else
    user=${1}
    status t "Remove '${user}' admin privileges" "${name}"
    # Check user is valid
    if ! dscl . list /users | grep -q "${user}"; then
      status e "'${user}' is not a user"
    elif [[ "${user}" == "admin" ]]; then
      status e "'${user}' should keep admin privileges"
    else
      status w "Removing '${user}' admin privileges in 3 seconds..."
      sleep 3
      status a "Remove '${user}' from admin"
      sudo dscl . -delete /Groups/admin GroupMembership ${user}
      status b "Delete '${user}' membership in /Groups/admin"
      user_UID=$(dscl . -read /Users/${user} GeneratedUID | cut -d ' ' -f 2)
      sudo dscl . -delete /Groups/admin GroupMembers ${user_UID}
      status b "Delete '${user_UID}' member in /Groups/admin"
      sudo -k
      status b "üç∫  Fin. '${user}' = standard"
    fi
  fi
}

# Hide / unhide use profile from login screens and moves home directory to /var/
# Follows macOS-Security-and-Privacy-Guide ‚Äì¬†@drduh guidelines
# https://support.apple.com/en-us/HT203998
# Hide from login screen 
#   $ sudo dscl . create /Users/hiddenuser IsHidden 1
# Hide home directory and share point
#   $ sudo mv /Users/hiddenuser /var/hiddenuser
#   $ sudo dscl . -create /Users/hiddenuser NFSHomeDirectory /var/hiddenuser
#   $ sudo dscl . -delete "/SharePoints/Hidden User's Public Folder"
function mv_user() {
  name="${prefix}${0}"
  if [ $# -ne 1 ]; then
    status e "Usage: hide_user <username>"
  elif [[ "$(uname)" != "Darwin"  ]]; then
    status e "Usage: only run this command on macOS"
  else
    user=${1}
    status t "Hide/Restore '${user}' from login & Finder" "${name}"

    # Check user is valid
    if ! dscl . list /users | grep -q "${user}"; then
      status e "'${user}' is not a user"
    elif [[ "${user}" == "$(whoami)" ]]; then
      status e "'${user}' should not hide oneself"
    else
      userStatus=$(dscl . read /Users/${user} IsHidden | cut -f 2 -d " ")
      visible="0"
      if [ "${userStatus}" = "${visible}" ]; then
        status w "Hiding '${user}' from login & Finder in 3 seconds..."
        sleep 3
        status a "Hide '${user}' from login & Finder"
        sudo dscl . create /Users/${user} IsHidden 1
        status b "Hide '${user}' from login"
        sudo mv /Users/${user} /var/${user}
        status b "Move home directory to /var/${user}"
        sudo dscl . -create /Users/${user} NFSHomeDirectory /var/${user}
        status b "Update ${user} record with home directory /var/${user}"
        sudo dscl . -delete "/SharePoints/${user}'s Public Folder"
        status b "Remove ${user} Public Folder"
        result="hidden"
      else
        status w "Restoring '${user}' to login & Finder in 3 seconds..."
        sleep 3
        status a "Restore '${user}' to login & Finder"
        sudo dscl . create /Users/${user} IsHidden 0
        status b "Restore '${user}' to login"
        sudo mv /var/${user} /Users/${user}
        status b "Move home directory to /Users/${user}"
        sudo dscl . -create /Users/${user} NFSHomeDirectory /Users/${user}
        status b "Update ${user} record with home directory /Users/${user}"
        sudo dscl . -create "/SharePoints/${user}'s Public Folder"
        status b "Restore ${user} Public Folder"
        result="restored"
      fi      

      sudo -k
      status b "üç∫  Fin. '${user}' = ${result}"
    fi
  fi
}

# Docker
function dka() {
  docker kill $(docker ps -q)
}
function drmc() {
  docker rm $(docker ps -a -q)
}
function drmi() {
  docker rmi -f $(docker images -q)
}

# zmv
function zm4b() {
  \zmv '*.m4a' '$(basename $f .m4a).m4b'   # all *.m4a -> *.m4b bookmarkable audiobooks
}


# Other Sources
# https://github.com/mathiasbynens/dotfiles/blob/master/.functions
# https://github.com/oieduardorabelo/dotfiles/blob/master/functions.sh

# Reload Antibody
function antiup() {
	rm -rf `antibody home`
	bash -c "antibody bundle < ~/.zshplugins > ~/.zsh_plugins.sh"
	cat ~/.zsh_plugins.sh
	reload
}

# Create a .tar.gz archive, using `zopfli`, `pigz` or `gzip` for compression
function targz() {
	local tmpFile="${@%/}.tar";
	tar -cvf "${tmpFile}" --exclude=".DS_Store" "${@}" || return 1;

	size=$(
		stat -f"%z" "${tmpFile}" 2> /dev/null; # macOS `stat`
		stat -c"%s" "${tmpFile}" 2> /dev/null;  # GNU `stat`
	);

	local cmd="";
	if (( size < 52428800 )) && hash zopfli 2> /dev/null; then
		# the .tar file is smaller than 50 MB and Zopfli is available; use it
		cmd="zopfli";
	else
		if hash pigz 2> /dev/null; then
			cmd="pigz";
		else
			cmd="gzip";
		fi;
	fi;

	echo "Compressing .tar ($((size / 1000)) kB) using \`${cmd}\`‚Ä¶";
	"${cmd}" -v "${tmpFile}" || return 1;
	[ -f "${tmpFile}" ] && rm "${tmpFile}";

	zippedSize=$(
		stat -f"%z" "${tmpFile}.gz" 2> /dev/null; # macOS `stat`
		stat -c"%s" "${tmpFile}.gz" 2> /dev/null; # GNU `stat`
	);

	echo "${tmpFile}.gz ($((zippedSize / 1000)) kB) created successfully.";
}

# Start an HTTP server from a directory, optionally specifying the port
function server() {
	local port="${1:-8000}";
	sleep 1 && open "http://localhost:${port}/" &
	# Set the default Content-Type to `text/plain` instead of `application/octet-stream`
	# And serve everything as UTF-8 (although not technically correct, this doesn‚Äôt break anything for binary files)
	python -c $'import SimpleHTTPServer;\nmap = SimpleHTTPServer.SimpleHTTPRequestHandler.extensions_map;\nmap[""] = "text/plain";\nfor key, value in map.items():\n\tmap[key] = value + ";charset=UTF-8";\nSimpleHTTPServer.test();' "$port";
}


# Syntax-highlight JSON strings or files
# Usage: `json '{"foo":42}'` or `echo '{"foo":42}' | json`
function json() {
	if [ -t 0 ]; then # argument
		python -mjson.tool <<< "$*" | pygmentize -l javascript;
	else # pipe
		python -mjson.tool | pygmentize -l javascript;
	fi;
}


# `s` with no arguments opens the current directory in Sublime Text, otherwise
# opens the given location
function s() {
	if [ $# -eq 0 ]; then
		subl .;
	else
		subl "$@";
	fi;
}

# `a` with no arguments opens the current directory in Atom Editor, otherwise
# opens the given location
function a() {
	if [ $# -eq 0 ]; then
		atom .;
	else
		atom "$@";
	fi;
}

# `c` with no arguments opens the current directory, otherwise opens the given
# location
function c() {
  if [ $# -eq 0 ]; then
    code .;
  else
    code "$@";
  fi;
}


# `v` with no arguments opens the current directory in Vim, otherwise opens the
# given location
function v() {
	if [ $# -eq 0 ]; then
		vim .;
	else
		vim "$@";
	fi;
}

# `o` with no arguments opens the current directory, otherwise opens the given
# location
function o() {
	if [ $# -eq 0 ]; then
		open .;
	else
		open "$@";
	fi;
}

# `tre` is a shorthand for `tree` with hidden files and color enabled, ignoring
# the `.git` directory, listing directories first. The output gets piped into
# `less` with options to preserve color and line numbers, unless the output is
# small enough for one screen.
function tre() {
	tree -aC -I '.git|node_modules|bower_components' --dirsfirst "$@" | less -FRNX;
}

# Usage: extract <file>
# Description: extracts archived files / mounts disk images
# Note: .dmg/hdiutil is Mac OS X-specific.
# credit: http://nparikh.org/notes/zshrc.txt
function extract() {
  if [ -f "$1" ]; then
    case "$1" in
      *.tar.bz2)  tar -jxvf "$1"                        ;;
      *.tar.gz)   tar -zxvf "$1"                        ;;
      *.bz2)      bunzip2 "$1"                          ;;
      *.dmg)      hdiutil mount "$1"                    ;;
      *.gz)       gunzip "$1"                           ;;
      *.tar)      tar -xvf "$1"                         ;;
      *.tbz2)     tar -jxvf "$1"                        ;;
      *.tgz)      tar -zxvf "$1"                        ;;
      *.zip)      unzip "$1"                            ;;
      *.ZIP)      unzip "$1"                            ;;
      *.pax)      pax -r < "$1"                         ;;
      *.pax.Z)    uncompress "$1" --stdout | pax -r     ;;
      *.Z)        uncompress "$1"                       ;;
      *)          echo "'$1' cannot be extracted/mounted via extract()" ;;
    esac
  else
    echo "'$1' is not a valid file"
	fi
}
